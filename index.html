<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كشف الحساب التفصيلي | Transaction-Level Statement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        @media print {
            .no-print { display: none !important; }
            .print-shadow-none { shadow: none !important; }
            body { background-color: white; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #e2e8f0 !important; }
        }
        .balance-column { background-color: #eff6ff !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-lg text-white">
                    <i data-lucide="file-text"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">الأستاذ العام - وضع المطور</h1>
                    <p class="text-sm text-gray-500">Transaction-Level Statement with Cumulative Balance</p>
                </div>
            </div>
            <button onclick="window.print()" class="no-print flex items-center gap-2 bg-gray-800 text-white px-6 py-2.5 rounded-lg hover:bg-black transition-all">
                <i data-lucide="printer" class="w-4 h-4"></i>
                طباعة كشف الحساب
            </button>
        </div>

        <div class="no-print bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
            <div class="flex items-center gap-2 mb-6 border-b pb-4">
                <i data-lucide="filter" class="text-blue-600 w-5 h-5"></i>
                <h2 class="font-bold text-gray-700">محرك الفلاتر المتقدم</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">الحساب الرئيسي</label>
                    <select id="accountFilter" onchange="applyFilters()" class="w-full border border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                        <option value="">كل الحسابات</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">الطرف (عميل/مورد)</label>
                    <select id="partyFilter" onchange="applyFilters()" class="w-full border border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                        <option value="">كل الأطراف</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">من تاريخ</label>
                    <input type="date" id="dateFrom" onchange="applyFilters()" class="w-full border border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">إلى تاريخ</label>
                    <input type="date" id="dateTo" onchange="applyFilters()" class="w-full border border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-6 rounded-xl border-r-4 border-green-500 shadow-sm">
                <p class="text-sm text-gray-500 mb-1 font-bold">إجمالي المدين</p>
                <h3 id="totalDebit" class="text-2xl font-bold text-green-600">0.00</h3>
            </div>
            <div class="bg-white p-6 rounded-xl border-r-4 border-red-500 shadow-sm">
                <p class="text-sm text-gray-500 mb-1 font-bold">إجمالي الدائن</p>
                <h3 id="totalCredit" class="text-2xl font-bold text-red-600">0.00</h3>
            </div>
            <div id="balanceCard" class="bg-white p-6 rounded-xl border-r-4 border-blue-500 shadow-sm">
                <p class="text-sm text-gray-500 mb-1 font-bold">الرصيد الصافي</p>
                <h3 id="finalBalance" class="text-2xl font-bold text-blue-600">0.00</h3>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-right">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="px-4 py-4 font-bold">التاريخ</th>
                            <th class="px-4 py-4 font-bold">رقم السند</th>
                            <th class="px-4 py-4 font-bold">الحساب</th>
                            <th class="px-4 py-4 font-bold">الطرف</th>
                            <th class="px-4 py-4 font-bold">البيان / الملاحظات</th>
                            <th class="px-4 py-4 font-bold text-center">مدين (+)</th>
                            <th class="px-4 py-4 font-bold text-center">دائن (-)</th>
                            <th class="px-4 py-4 font-bold text-center bg-blue-700">الرصيد التراكمي</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody" class="divide-y divide-gray-100">
                        </tbody>
                    <tfoot class="bg-gray-50 font-bold border-t-2 border-gray-300">
                        <tr id="ledgerFooter">
                            </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div class="mt-8 flex justify-between items-center text-xs text-gray-400 no-print">
            <p>نظام الأستاذ العام المتطور v2.0 | تم التوليد بواسطة Gemini AI</p>
            <p id="timestamp"></p>
        </div>
    </div>

    <script>
        // 1. بيانات محاكية (Mock Data) مطابقة لمتطلباتك
        const entries = [
            { id: 1, date: '2025-12-01', voucher: 'JV-001', account: 'Cash - M', party: 'Sky Star Company', remarks: 'رصيد أول المدة', debit: 50000, credit: 0 },
            { id: 2, date: '2025-12-02', voucher: 'PV-021', account: 'Cash - M', party: 'Supplier A', remarks: 'شراء أجهزة مكتبية', debit: 0, credit: 15000 },
            { id: 3, date: '2025-12-05', voucher: 'RV-044', account: 'Cash - M', party: 'Customer B', remarks: 'دفعة من حساب عميل', debit: 25000, credit: 0 },
            { id: 4, date: '2025-12-10', voucher: 'JV-002', account: 'Bank SSC', party: 'Sky Star Company', remarks: 'تحويل بنكي', debit: 100000, credit: 0 },
            { id: 5, date: '2025-12-15', voucher: 'PV-022', account: 'Cash - M', party: 'Supplier A', remarks: 'مصاريف صيانة', debit: 0, credit: 2000 },
            { id: 6, date: '2025-12-20', voucher: 'JV-003', account: 'Cash - M', party: 'Sky Star Company', remarks: 'سحب نقدي للعهدة', debit: 0, credit: 5000 }
        ];

        // 2. تعبئة القوائم المنسدلة (Filters Initialization)
        function initFilters() {
            const accSelect = document.getElementById('accountFilter');
            const partySelect = document.getElementById('partyFilter');
            
            const accounts = [...new Set(entries.map(e => e.account))];
            const parties = [...new Set(entries.map(e => e.party))];

            accounts.forEach(acc => accSelect.innerHTML += `<option value="${acc}">${acc}</option>`);
            parties.forEach(p => partySelect.innerHTML += `<option value="${p}">${p}</option>`);
            
            document.getElementById('timestamp').innerText = "تاريخ التقرير: " + new Date().toLocaleString('ar-EG');
        }

        // 3. تنسيق الأرقام
        const fmt = (num) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);

        // 4. المحرك الرئيسي للفلاتر والحساب التراكمي
        function applyFilters() {
            const accVal = document.getElementById('accountFilter').value;
            const partyVal = document.getElementById('partyFilter').value;
            const dFrom = document.getElementById('dateFrom').value;
            const dTo = document.getElementById('dateTo').value;

            let filtered = entries.filter(e => {
                return (!accVal || e.account === accVal) &&
                       (!partyVal || e.party === partyVal) &&
                       (!dFrom || e.date >= dFrom) &&
                       (!dTo || e.date <= dTo);
            });

            // ترتيب البيانات تاريخياً لضمان صحة الرصيد التراكمي
            filtered.sort((a, b) => new Date(a.date) - new Date(b.date));

            const tbody = document.getElementById('ledgerBody');
            const tfoot = document.getElementById('ledgerFooter');
            tbody.innerHTML = '';
            
            let runningBalance = 0;
            let totalD = 0;
            let totalC = 0;

            filtered.forEach((e, index) => {
                runningBalance += (e.debit - e.credit);
                totalD += e.debit;
                totalC += e.credit;

                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="px-4 py-4 text-gray-600 font-mono">${e.date}</td>
                        <td class="px-4 py-4 font-bold text-blue-600">${e.voucher}</td>
                        <td class="px-4 py-4">${e.account}</td>
                        <td class="px-4 py-4 text-gray-500">${e.party}</td>
                        <td class="px-4 py-4 text-xs max-w-xs">${e.remarks}</td>
                        <td class="px-4 py-4 text-center font-bold text-green-600">${e.debit > 0 ? fmt(e.debit) : '-'}</td>
                        <td class="px-4 py-4 text-center font-bold text-red-600">${e.credit > 0 ? fmt(e.credit) : '-'}</td>
                        <td class="px-4 py-4 text-center font-black balance-column ${runningBalance >= 0 ? 'text-blue-700' : 'text-red-700'}">${fmt(runningBalance)}</td>
                    </tr>
                `;
            });

            // تحديث بطاقات الملخص
            document.getElementById('totalDebit').innerText = fmt(totalD);
            document.getElementById('totalCredit').innerText = fmt(totalC);
            document.getElementById('finalBalance').innerText = fmt(runningBalance);
            
            // تحديث تذييل الجدول
            tfoot.innerHTML = `
                <td colspan="5" class="px-4 py-4 text-left">الإجماليات المستخرجة</td>
                <td class="px-4 py-4 text-center text-green-600">${fmt(totalD)}</td>
                <td class="px-4 py-4 text-center text-red-600">${fmt(totalC)}</td>
                <td class="px-4 py-4 text-center bg-blue-100 text-blue-800">${fmt(runningBalance)}</td>
            `;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-10 text-center text-gray-400">لا توجد بيانات تطابق الفلاتر المحددة</td></tr>`;
            }
        }

        // تشغيل الوظائف عند التحميل
        window.onload = () => {
            initFilters();
            applyFilters();
            lucide.createIcons();
        };
    </script>
</body>
</html>


